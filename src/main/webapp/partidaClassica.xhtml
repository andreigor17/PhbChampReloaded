<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui"
                template="vercel.xhtml">

    <ui:define name="content">
        <h:form id="formPartidaClassica" enctype="multipart/form-data">

            <script type="text/javascript">
                function handleDrop(event, ui) {
                    var droppedProduct = ui.draggable;
                    droppedProduct.fadeOut('fast');
                }
            </script>

            <!-- Header -->
            <div class="surface-card shadow-2 border-round mb-4 p-4">
                <div class="flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="flex-1">
                        <div class="flex align-items-center mb-2">
                            <i class="pi pi-users text-4xl mr-3"></i>
                            <h1 class="text-900 font-bold text-4xl m-0">Criar Partida Clássica</h1>
                        </div>
                        <p class="text-600 text-lg m-0">Selecione os jogadores e monte os times</p>
                    </div>
                    <div class="flex gap-2">
                        <p:commandButton value="Cadastrar Player" 
                                         icon="pi pi-user-plus"
                                         styleClass="p-button-outlined"
                                         action="/criarPlayer?faces-redirect=true" />
                    </div>
                </div>
            </div>


            <!-- Card: Jogadores Disponíveis -->
            <div class="surface-card shadow-2 border-round mb-4 p-4">
                <h2 class="text-900 font-bold text-2xl mb-4">
                    <i class="pi pi-list mr-2"></i>Jogadores Disponíveis
                </h2>

                <p:dataTable id="jogadoresDisponives" 
                             var="player" 
                             value="#{managerPartida.pickedPlayers}" 
                             emptyMessage="Nenhum player selecionado!"
                             styleClass="p-datatable-striped"
                             paginator="true"
                             rows="10">

                    <p:column style="width: 50px; text-align: center;">
                        <h:outputText id="dragIcon" styleClass="pi pi-arrows-alt" 
                                      style="cursor: move; font-size: 1.2rem;" />
                        <p:draggable for="dragIcon" revert="true" helper="clone" />
                    </p:column>

                    <p:column headerText="Nome">
                        <div class="flex align-items-center gap-2">
                            <div class="participant-avatar" style="width: 40px; height: 40px; font-size: 16px; margin: 0;">
                                #{player.nome.substring(0,1)}
                            </div>
                            <div>
                                <strong>#{player.nome}</strong>
                                <h:panelGroup rendered="#{not empty player.nick}">
                                    <small class="text-600"> "#{player.nick}"</small>
                                </h:panelGroup>
                                #{player.sobreNome}
                            </div>
                        </div>
                    </p:column>

                    <p:column headerText="Função" style="width: 150px;">
                        <h:outputText value="#{player.funcao}" />
                    </p:column>
                </p:dataTable>
            </div>

            <!-- Times -->
            <div class="grid">
                <!-- Time 1 -->
                <div class="col-12 lg:col-6">
                    <p:fieldset id="jogadoresTime1" 
                                legend="Time 1" 
                                styleClass="surface-card shadow-2 border-round">

                        <p:outputPanel id="dropArea1">
                            <h:panelGroup rendered="#{empty managerPartida.droppedPlayers1}">
                                <div class="text-center p-6">
                                    <i class="pi pi-inbox text-6xl text-400 mb-3"></i>
                                    <p class="text-600 text-xl m-0">Arraste jogadores aqui</p>
                                </div>
                            </h:panelGroup>

                            <p:dataTable id="selectedPlayersTable1" 
                                         var="player" 
                                         value="#{managerPartida.droppedPlayers1}"
                                         rendered="#{not empty managerPartida.droppedPlayers1}"
                                         styleClass="p-datatable-sm">

                                <p:column headerText="Nome">
                                    <div class="flex align-items-center gap-2">
                                        <div class="participant-avatar" style="width: 35px; height: 35px; font-size: 14px; margin: 0;">
                                            #{player.nome.substring(0,1)}
                                        </div>
                                        <div>
                                            <strong>#{player.nome}</strong>
                                            <h:panelGroup rendered="#{not empty player.nick}">
                                                <small class="text-600"> "#{player.nick}"</small>
                                            </h:panelGroup>
                                            #{player.sobreNome}
                                        </div>
                                    </div>
                                </p:column>

                                <p:column headerText="Função" style="width: 120px;">
                                    <h:outputText value="#{player.funcao}" />
                                </p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:fieldset>
                </div>

                <!-- Time 2 -->
                <div class="col-12 lg:col-6">
                    <p:fieldset id="jogadoresTime2" 
                                legend="Time 2" 
                                styleClass="surface-card shadow-2 border-round">

                        <p:outputPanel id="dropArea2">
                            <h:panelGroup rendered="#{empty managerPartida.droppedPlayers2}">
                                <div class="text-center p-6">
                                    <i class="pi pi-inbox text-6xl text-400 mb-3"></i>
                                    <p class="text-600 text-xl m-0">Arraste jogadores aqui</p>
                                </div>
                            </h:panelGroup>

                            <p:dataTable id="selectedPlayersTable2" 
                                         var="player" 
                                         value="#{managerPartida.droppedPlayers2}"
                                         rendered="#{not empty managerPartida.droppedPlayers2}"
                                         styleClass="p-datatable-sm">

                                <p:column headerText="Nome">
                                    <div class="flex align-items-center gap-2">
                                        <div class="participant-avatar" style="width: 35px; height: 35px; font-size: 14px; margin: 0;">
                                            #{player.nome.substring(0,1)}
                                        </div>
                                        <div>
                                            <strong>#{player.nome}</strong>
                                            <h:panelGroup rendered="#{not empty player.nick}">
                                                <small class="text-600"> "#{player.nick}"</small>
                                            </h:panelGroup>
                                            #{player.sobreNome}
                                        </div>
                                    </div>
                                </p:column>

                                <p:column headerText="Função" style="width: 120px;">
                                    <h:outputText value="#{player.funcao}" />
                                </p:column>
                            </p:dataTable>
                        </p:outputPanel>
                    </p:fieldset>
                </div>
            </div>

            <!-- Droppables -->
            <p:droppable for="jogadoresTime1" 
                         tolerance="touch" 
                         activeStyleClass="ui-state-highlight"
                         datasource="jogadoresDisponives" 
                         onDrop="handleDrop">
                <p:ajax listener="#{managerPartida.onPlayerDrop1}" 
                        update="dropArea1 jogadoresDisponives" />
            </p:droppable>

            <p:droppable for="jogadoresTime2" 
                         tolerance="touch" 
                         activeStyleClass="ui-state-highlight"
                         datasource="jogadoresDisponives" 
                         onDrop="handleDrop">
                <p:ajax listener="#{managerPartida.onPlayerDrop2}" 
                        update="dropArea2 jogadoresDisponives" />
            </p:droppable>

            <!-- Rodapé com Botões -->
            <div class="surface-card shadow-2 border-round mt-4 p-4">
                <div class="flex justify-content-end gap-2">
                    <p:commandButton value="Cancelar" 
                                     icon="pi pi-times"
                                     styleClass="p-button-outlined p-button-secondary"
                                     action="/indexPartida?faces-redirect=true"
                                     immediate="true"
                                     process="@this" />
                    <p:commandButton value="Avançar" 
                                     icon="pi pi-arrow-right"
                                     styleClass="p-button-success"
                                     actionListener="#{managerPartida.dialogPartidaClassica()}"
                                     process="@form"
                                     update="@form" />
                </div>
            </div>

            <!-- Dialog: Seleção de Capitães -->
            <p:dialog id="selecaoDeCapitaesDialog"
                      widgetVar="selecaoDeCapitaesDialog"
                      header="Seleção de Capitães"
                      modal="true"
                      resizable="false"
                      draggable="false"
                      closeOnEscape="true"
                      showEffect="fade"
                      hideEffect="fade"
                      width="900">

                <div class="formgrid grid">
                    <div class="field col-12 mb-4">
                        <p:outputLabel for="tipoEscolha" class="block font-medium text-900 mb-3">Forma de escolha dos capitães</p:outputLabel>
                        <p:selectOneRadio id="tipoEscolha" 
                                          value="#{managerPartida.tipoEscolhaCapitaes}" 
                                          unselectable="true">
                            <f:selectItem itemLabel="Sorteio" itemValue="1" />
                            <f:selectItem itemLabel="Picks" itemValue="2" />
                            <p:ajax process="@this" />
                        </p:selectOneRadio>
                    </div>

                    <div class="field col-12">
                        <p:pickList id="grupoPickList" 
                                    value="#{managerPartida.playerGroupList}" 
                                    var="player"
                                    filterMatchMode="contains" 
                                    showSourceFilter="true" 
                                    showTargetFilter="true"
                                    itemValue="#{player}" 
                                    itemLabel="#{player.nick}" 
                                    converter="player_converter"
                                    responsive="true">
                            <f:facet name="sourceCaption">Players Disponíveis</f:facet>
                            <f:facet name="targetCaption">Capitães Selecionados</f:facet>
                        </p:pickList>
                    </div>
                </div>

                <div class="flex justify-content-end gap-2 mt-4">
                    <p:commandButton value="Cancelar"
                                     icon="pi pi-times"
                                     styleClass="p-button-outlined p-button-secondary"
                                     action="/indexPartida?faces-redirect=true"
                                     immediate="true" />
                    <p:commandButton value="Confirmar"
                                     icon="pi pi-check"
                                     styleClass="p-button-success"
                                     process="@form"
                                     update="@form"
                                     actionListener="#{managerPartida.selecionarPartidaClassica()}" />
                </div>
            </p:dialog>

            <!-- Dialog: Confirmar Criação X5 -->
            <p:dialog id="confirmarCriacaoX5Dialog"
                      widgetVar="confirmarCriacaoX5Dialog"
                      header="Configurar Partida"
                      modal="true"
                      resizable="false"
                      draggable="false"
                      closeOnEscape="true"
                      showEffect="fade"
                      hideEffect="fade"
                      width="500">

                <div class="formgrid grid">
                    <div class="field col-12">
                        <p:outputLabel for="nomeTime1Dialog" class="block font-medium text-900 mb-2">Nome do Time 1</p:outputLabel>
                        <p:inputText id="nomeTime1Dialog" 
                                     value="#{managerPartida.nomeTime1}"
                                     placeholder="Digite o nome do time 1"
                                     styleClass="w-full" />
                    </div>

                    <div class="field col-12">
                        <p:outputLabel for="nomeTime2Dialog" class="block font-medium text-900 mb-2">Nome do Time 2</p:outputLabel>
                        <p:inputText id="nomeTime2Dialog" 
                                     value="#{managerPartida.nomeTime2}"
                                     placeholder="Digite o nome do time 2"
                                     styleClass="w-full" />
                    </div>

                    <div class="field col-12">
                        <p:outputLabel for="qtdRounds" class="block font-medium text-900 mb-3">Número de Rounds</p:outputLabel>
                        <p:selectOneRadio id="qtdRounds" 
                                          value="#{managerPartida.qtdItensPartidas}" 
                                          unselectable="true">
                            <f:selectItem itemLabel="MD1 (Melhor de 1)" itemValue="1" />
                            <f:selectItem itemLabel="MD3 (Melhor de 3)" itemValue="3" />
                            <f:selectItem itemLabel="MD5 (Melhor de 5)" itemValue="5" />
                        </p:selectOneRadio>
                    </div>
                </div>

                <div class="flex justify-content-end gap-2 mt-4">
                    <p:commandButton value="Cancelar"
                                     icon="pi pi-times"
                                     styleClass="p-button-outlined p-button-secondary"
                                     oncomplete="PF('confirmarCriacaoX5Dialog').hide();" />
                    <p:commandButton value="Sortear Times"
                                     icon="pi pi-check"
                                     styleClass="p-button-success"
                                     process="@form"
                                     update="@form"
                                     actionListener="#{managerPartida.salvarPartidaClassica()}" />
                </div>
            </p:dialog>

            <!-- Dialog: Confirmar Criação X5 com Times Cadastrados -->
            <p:dialog id="confirmarCriacaoX5TimesDialog"
                      widgetVar="confirmarCriacaoX5TimesDialog"
                      header="Configurar Partida com Times"
                      modal="true"
                      resizable="false"
                      draggable="false"
                      closeOnEscape="true"
                      showEffect="fade"
                      hideEffect="fade"
                      width="500">

                <div class="formgrid grid">
                    <div class="field col-12">
                        <p:outputLabel for="time1Auto" class="block font-medium text-900 mb-2">Time 1 *</p:outputLabel>
                        <p:autoComplete id="time1Auto" 
                                        value="#{managerPartida.time1}"
                                        forceSelection="true" 
                                        dropdown="true" 
                                        var="team" 
                                        itemValue="#{team}"
                                        itemLabel="#{team.nome}" 
                                        completeMethod="#{managerAutoCompletes.autoCompletarTime()}"
                                        converter="time_converter"
                                        required="true"
                                        requiredMessage="Time 1 é obrigatório"
                                        placeholder="Selecione o time 1"
                                        styleClass="w-full" />
                    </div>

                    <div class="field col-12">
                        <p:outputLabel for="time2Auto" class="block font-medium text-900 mb-2">Time 2 *</p:outputLabel>
                        <p:autoComplete id="time2Auto" 
                                        value="#{managerPartida.time2}"
                                        forceSelection="true" 
                                        dropdown="true" 
                                        var="team" 
                                        itemValue="#{team}"
                                        itemLabel="#{team.nome}" 
                                        completeMethod="#{managerAutoCompletes.autoCompletarTime()}"
                                        converter="time_converter"
                                        required="true"
                                        requiredMessage="Time 2 é obrigatório"
                                        placeholder="Selecione o time 2"
                                        styleClass="w-full" />
                    </div>

                    <div class="field col-12">
                        <p:outputLabel for="qtdRoundsTimes" class="block font-medium text-900 mb-3">Número de Rounds</p:outputLabel>
                        <p:selectOneRadio id="qtdRoundsTimes" 
                                          value="#{managerPartida.qtdItensPartidas}" 
                                          unselectable="true">
                            <f:selectItem itemLabel="MD1 (Melhor de 1)" itemValue="1" />
                            <f:selectItem itemLabel="MD3 (Melhor de 3)" itemValue="3" />
                            <f:selectItem itemLabel="MD5 (Melhor de 5)" itemValue="5" />
                        </p:selectOneRadio>
                    </div>
                </div>

                <div class="flex justify-content-end gap-2 mt-4">
                    <p:commandButton value="Cancelar"
                                     icon="pi pi-times"
                                     styleClass="p-button-outlined p-button-secondary"
                                     oncomplete="PF('confirmarCriacaoX5TimesDialog').hide();" />
                    <p:commandButton value="Criar Partida"
                                     icon="pi pi-check"
                                     styleClass="p-button-success"
                                     process="@form"
                                     update="@form"
                                     actionListener="#{managerPartida.sorteioX5()}" />
                </div>
            </p:dialog>

        </h:form>

        <style>
            .participant-avatar {
                border-radius: 50%;
                background-color: #f8f9fa;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: bold;
                color: #6c757d;
            }

            .ui-state-highlight {
                background-color: #e3f2fd !important;
                border: 2px dashed #2196f3 !important;
            }

            .p-picklist {
                display: flex;
                gap: 1rem;
            }

            .p-picklist-list {
                min-height: 300px;
            }
        </style>
    </ui:define>
</ui:composition>