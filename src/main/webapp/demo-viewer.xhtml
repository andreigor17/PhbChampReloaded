<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui">

<h:head>
    <title>PhbChamp - Visualizador de Demos CS2</title>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.8;
            font-size: 1.1em;
        }
        
        .content {
            padding: 30px;
        }
        
        .upload-section {
            background: #f7fafc;
            border: 3px dashed #cbd5e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        
        .upload-section:hover {
            border-color: #667eea;
            background: #edf2f7;
        }
        
        .upload-section.dragover {
            border-color: #667eea;
            background: #e6fffa;
            transform: scale(1.02);
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 50px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .loading.active {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .demo-info {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .demo-info.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .info-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .info-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }
        
        .section-title {
            font-size: 1.5em;
            color: #2d3748;
            margin: 30px 0 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .table-container {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        thead {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
        }
        
        tbody tr {
            border-bottom: 1px solid #e2e8f0;
            transition: all 0.2s;
        }
        
        tbody tr:hover {
            background: #f7fafc;
            transform: scale(1.01);
        }
        
        .team-ct {
            color: #3182ce;
            font-weight: bold;
        }
        
        .team-t {
            color: #e53e3e;
            font-weight: bold;
        }
        
        .round-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
        }
        
        .round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .round-number {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3748;
        }
        
        .round-score {
            font-size: 1.2em;
        }
        
        .kills-list {
            list-style: none;
            padding: 0;
        }
        
        .kill-item {
            padding: 10px;
            margin: 5px 0;
            background: #f7fafc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weapon-icon {
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        
        .headshot-badge {
            background: #e53e3e;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .error {
            background: #fff5f5;
            color: #c53030;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #e53e3e;
            margin: 20px 0;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .tab {
            padding: 15px 30px;
            background: transparent;
            border: none;
            color: #718096;
            cursor: pointer;
            font-size: 1.1em;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
    </style>
</h:head>

<h:body>
    <div class="container">
        <div class="header">
            <h1>üéÆ Visualizador de Demos CS2</h1>
            <p>Analise suas partidas de Counter-Strike 2 em detalhes</p>
        </div>
        
        <div class="content">
            <!-- Se√ß√£o de Upload -->
            <div class="upload-section" id="uploadSection">
                <h2 style="margin-bottom: 20px; color: #2d3748;">Carregar Demo</h2>
                <p style="margin-bottom: 20px; color: #718096;">
                    Arraste um arquivo .dem ou .zip aqui, ou clique no bot√£o abaixo
                </p>
                <input type="file" id="fileInput" class="file-input" accept=".dem,.zip" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    üìÅ Selecionar Arquivo
                </button>
                
                <h:form style="margin-top: 30px;">
                    <p style="margin-bottom: 15px; color: #718096;">Ou selecione um demo j√° carregado:</p>
                    <p:selectOneMenu id="demoSelect" style="width: 300px;">
                        <f:selectItem itemLabel="Selecione um demo..." itemValue="" />
                        <!-- Aqui vir√£o os demos do banco -->
                    </p:selectOneMenu>
                    <p:commandButton value="Carregar" 
                                     styleClass="btn-secondary" 
                                     style="margin-left: 10px;"
                                     onclick="loadSelectedDemo(); return false;" />
                </h:form>
            </div>
            
            <!-- Loading -->
            <div class="loading" id="loadingSection">
                <div class="spinner"></div>
                <p>Analisando demo... Isso pode levar alguns segundos.</p>
            </div>
            
            <!-- Informa√ß√µes do Demo -->
            <div class="demo-info" id="demoInfo">
                <div class="info-grid" id="headerInfo"></div>
                
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="showTab('overview')">üìä Vis√£o Geral</button>
                    <button class="tab" onclick="showTab('players')">üë• Jogadores</button>
                    <button class="tab" onclick="showTab('rounds')">üîÑ Rounds</button>
                    <button class="tab" onclick="showTab('timeline')">‚è±Ô∏è Linha do Tempo</button>
                </div>
                
                <!-- Tab: Vis√£o Geral -->
                <div id="tab-overview" class="tab-content active">
                    <h2 class="section-title">üìà Estat√≠sticas Gerais</h2>
                    <div id="overviewContent"></div>
                </div>
                
                <!-- Tab: Jogadores -->
                <div id="tab-players" class="tab-content">
                    <h2 class="section-title">üë• Estat√≠sticas dos Jogadores</h2>
                    <div class="table-container">
                        <table id="playersTable">
                            <thead>
                                <tr>
                                    <th>Jogador</th>
                                    <th>Time</th>
                                    <th>K</th>
                                    <th>D</th>
                                    <th>A</th>
                                    <th>K/D</th>
                                    <th>HS%</th>
                                    <th>MVP</th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Tab: Rounds -->
                <div id="tab-rounds" class="tab-content">
                    <h2 class="section-title">üîÑ Detalhes dos Rounds</h2>
                    <div id="roundsContent"></div>
                </div>
                
                <!-- Tab: Timeline -->
                <div id="tab-timeline" class="tab-content">
                    <h2 class="section-title">‚è±Ô∏è Linha do Tempo</h2>
                    <div id="timelineContent">
                        <p style="color: #718096; font-style: italic;">
                            Visualiza√ß√£o interativa da linha do tempo ser√° implementada aqui.
                            Mostrar√° eventos importantes como kills, plant/defuse da bomba, etc.
                        </p>
                    </div>
                </div>
                
                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn-secondary" onclick="resetViewer()">üîÑ Carregar Outro Demo</button>
                </div>
            </div>
            
            <!-- Error -->
            <div class="error" id="errorSection" style="display: none;"></div>
        </div>
    </div>

    <script type="text/javascript">
        //<![CDATA[
        let currentDemoData = null;
        
        // Configura√ß√£o de drag and drop
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });
        
        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });
        
        async function handleFile(file) {
            if (!file.name.endsWith('.dem') &amp;#38;&amp;#38; !file.name.endsWith('.zip')) {
                showError('Por favor, selecione um arquivo .dem ou .zip');
                return;
            }
            
            showLoading(true);
            hideError();
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch('/PhbChampAPI/api/demo/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentDemoData = data.analysis;
                    displayDemoInfo(data.analysis);
                } else {
                    showError(data.message || 'Erro ao processar demo');
                }
            } catch (error) {
                console.error('Erro:', error);
                showError('Erro ao enviar arquivo: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function loadDemoById(anexoId) {
            showLoading(true);
            hideError();
            
            try {
                const response = await fetch(`/PhbChampAPI/api/demo/analyze/${anexoId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    currentDemoData = data;
                    displayDemoInfo(data);
                } else {
                    showError('Erro ao carregar demo');
                }
            } catch (error) {
                console.error('Erro:', error);
                showError('Erro ao carregar demo: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        function displayDemoInfo(data) {
            const headerInfo = document.getElementById('headerInfo');
            const header = data.header || {};
            
            headerInfo.innerHTML = `
                <div class="info-card">
                    <h3>Mapa</h3>
                    <div class="value">${header.mapName || 'N/A'}</div>
                </div>
                <div class="info-card">
                    <h3>Dura√ß√£o</h3>
                    <div class="value">${formatDuration(header.duration)}</div>
                </div>
                <div class="info-card">
                    <h3>Tick Rate</h3>
                    <div class="value">${header.tickRate || 'N/A'}</div>
                </div>
                <div class="info-card">
                    <h3>Servidor</h3>
                    <div class="value" style="font-size: 1.2em;">${truncate(header.serverName || 'N/A', 20)}</div>
                </div>
            `;
            
            // Mostra a se√ß√£o de informa√ß√µes
            document.getElementById('demoInfo').classList.add('active');
            document.getElementById('uploadSection').style.display = 'none';
            
            // Preenche as tabs
            populateOverview(data);
            populatePlayers(data);
            populateRounds(data);
        }
        
        function populateOverview(data) {
            const content = document.getElementById('overviewContent');
            const header = data.header || {};
            
            content.innerHTML = `
                <div class="info-grid">
                    <div class="info-card">
                        <h3>Total de Rounds</h3>
                        <div class="value">${header.totalRounds || 'N/A'}</div>
                    </div>
                    <div class="info-card">
                        <h3>Tamanho do Arquivo</h3>
                        <div class="value">${formatBytes(data.fileSize)}</div>
                    </div>
                    <div class="info-card">
                        <h3>Nome do Arquivo</h3>
                        <div class="value" style="font-size: 1em;">${truncate(data.fileName, 25)}</div>
                    </div>
                </div>
                
                <div style="background: #f7fafc; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h3 style="margin-bottom: 15px; color: #2d3748;">‚ÑπÔ∏è Informa√ß√£o</h3>
                    <p style="color: #718096;">
                        Esta √© uma an√°lise b√°sica do demo. Para an√°lise completa com todas as estat√≠sticas,
                        posi√ß√µes dos jogadores e replay 3D, ser√° necess√°rio usar o parser completo demoparser2.
                    </p>
                    <p style="color: #718096; margin-top: 10px;">
                        <strong>Servidor:</strong> ${header.serverName || 'N/A'}<br/>
                        <strong>Tipo de Jogo:</strong> ${header.gameType || 'Competitivo'}
                    </p>
                </div>
            `;
        }
        
        function populatePlayers(data) {
            const tbody = document.getElementById('playersTableBody');
            
            if (!data.playerStats || data.playerStats.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; color: #718096; font-style: italic;">
                            Estat√≠sticas de jogadores n√£o dispon√≠veis. 
                            Para an√°lise completa, use o parser JavaScript no lado do cliente.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = data.playerStats.map(player => `
                <tr>
                    <td><strong>${player.playerName}</strong></td>
                    <td class="team-${player.team.toLowerCase()}">${player.team}</td>
                    <td>${player.kills}</td>
                    <td>${player.deaths}</td>
                    <td>${player.assists}</td>
                    <td>${player.kdr.toFixed(2)}</td>
                    <td>${((player.headshotKills / player.kills) * 100).toFixed(1)}%</td>
                    <td>${player.mvps}</td>
                </tr>
            `).join('');
        }
        
        function populateRounds(data) {
            const content = document.getElementById('roundsContent');
            
            if (!data.rounds || data.rounds.length === 0) {
                content.innerHTML = `
                    <div style="background: #f7fafc; padding: 20px; border-radius: 10px; text-align: center;">
                        <p style="color: #718096; font-style: italic;">
                            Informa√ß√µes detalhadas dos rounds n√£o dispon√≠veis.
                            Para an√°lise completa, use o parser JavaScript no lado do cliente.
                        </p>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = data.rounds.map(round => `
                <div class="round-card">
                    <div class="round-header">
                        <div class="round-number">Round ${round.roundNumber}</div>
                        <div class="round-score">
                            <span class="team-ct">CT ${round.ctScore}</span> - 
                            <span class="team-t">${round.tScore} T</span>
                        </div>
                    </div>
                    <div>
                        <strong>Vencedor:</strong> 
                        <span class="team-${round.winner.toLowerCase()}">${round.winner}</span>
                        <span style="color: #718096; margin-left: 10px;">(${round.winReason})</span>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>Dura√ß√£o:</strong> ${round.roundDuration.toFixed(1)}s
                    </div>
                    ${round.kills &amp;#38;&amp;#38; round.kills.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <strong>Kills:</strong>
                            <ul class="kills-list">
                                ${round.kills.map(kill => `
                                    <li class="kill-item">
                                        <span class="team-${kill.killerTeam.toLowerCase()}">${kill.killerName}</span>
                                        <span class="weapon-icon">${kill.weapon}</span>
                                        ${kill.headshot ? '<span class="headshot-badge">HS</span>' : ''}
                                        <span>‚Üí</span>
                                        <span class="team-${kill.victimTeam.toLowerCase()}">${kill.victimName}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function showTab(tabName) {
            // Remove active de todas as tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativa a tab selecionada
            event.target.classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }
        
        function showLoading(show) {
            document.getElementById('loadingSection').classList.toggle('active', show);
        }
        
        function showError(message) {
            const errorSection = document.getElementById('errorSection');
            errorSection.textContent = '‚ùå ' + message;
            errorSection.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('errorSection').style.display = 'none';
        }
        
        function resetViewer() {
            document.getElementById('uploadSection').style.display = 'block';
            document.getElementById('demoInfo').classList.remove('active');
            document.getElementById('fileInput').value = '';
            currentDemoData = null;
            hideError();
        }
        
        function loadSelectedDemo() {
            // Implementar carregamento de demo selecionado
            const select = document.getElementById('demoSelect');
            const anexoId = select.value;
            if (anexoId) {
                loadDemoById(anexoId);
            }
        }
        
        // Fun√ß√µes utilit√°rias
        function formatDuration(seconds) {
            if (!seconds) return 'N/A';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function formatBytes(bytes) {
            if (!bytes) return 'N/A';
            const mb = bytes / (1024 * 1024);
            if (mb >= 1) return mb.toFixed(2) + ' MB';
            return (bytes / 1024).toFixed(2) + ' KB';
        }
        
        function truncate(str, maxLength) {
            if (!str) return 'N/A';
            if (str.length <= maxLength) return str;
            return str.substring(0, maxLength) + '...';
        }
        
        // Verifica se h√° um ID de anexo na URL
        const urlParams = new URLSearchParams(window.location.search);
        const anexoId = urlParams.get('anexoId');
        if (anexoId) {
            loadDemoById(anexoId);
        }
        //]]>
    </script>
</h:body>
</html>

